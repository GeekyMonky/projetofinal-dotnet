@page "/dashboard"
@using System.Collections.Generic
@using System.Linq
@using MudBlazor

@inject DashboardService DashboardService

<PageTitle>Dashboard</PageTitle>

<h3>Dashboard</h3>

<div class="dashboard-container">
    <!-- KPI Cards -->
    <div class="dashboard-row">
        <div class="dashboard-card">
            <h4>Stock Exits Today</h4>
            <p class="dashboard-value" style="color: #e53935;">-@totalExits</p>
        </div>
        <div class="dashboard-card">
            <h4>Stock Entries Today</h4>
            <p class="dashboard-value" style="color: #43a047;">+@totalEntries</p>
        </div>
        <div class="dashboard-card">
            <h4>Total Stock Value</h4>
            <p class="dashboard-value">€@totalStockValue.ToString("N2")</p>
        </div>
    </div>
    

  
        <div class="dashboard-row">
            <!-- Stock by Category Pie Chart -->
            <div class="dashboard-section" style="flex: 1;">
                <h4>Stock Distribution by Category</h4>
                @if (isLoading)
                {
                    <p>Loading chart data...</p>
                }
                else
                {
                    <div style="height: 350px;">
                        <MudChart ChartType="ChartType.Pie"
                                  InputData="@categoryStockData"
                                  InputLabels="@categoryLabels"
                                  Width="100%" Height="300px"
                                  LegendPosition="Position.Bottom" />
                    </div>
                }
            </div>

            <!-- Top 5 Categories -->
            <div class="dashboard-section" style="flex: 1;">
                <h4>Top 5 Categories with Most Products</h4>
                <table class="dashboard-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Products</th>
                            <th>Total Quantity</th>
                            <th>Average Price</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var category in topCategoriesWithAverageCost)
                        {
                            <tr>
                                <td>@category.CategoryName</td>
                                <td>@category.ProductCount</td>
                                <td>@category.TotalQuantity</td>
                                <td>€@category.AverageCost.ToString("N2")</td>
                            </tr>
                        }
                        <tr style="font-weight:bold;">
                            <td>Total</td>
                            <td>@topCategoriesWithAverageCost.Sum(c => c.ProductCount)</td>
                            <td>@topCategoriesWithAverageCost.Sum(c => c.TotalQuantity)</td>
                            <td>
                                €@(
                                   topCategoriesWithAverageCost.Any()
                                   ? (topCategoriesWithAverageCost.Sum(c => c.AverageCost) / topCategoriesWithAverageCost.Count).ToString("N2")
                                   : "0.00"
                                   )
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

            
    </div>
    <div class="dashboard-row">
        <div class="dashboard-section" style="flex: 1;">
            <h4>Daily Stock Movements by Category (Last 15 Days)</h4>
            @if (isLoading)
            {
                <p>Loading daily movements...</p>
            }
            else
            {
                <MudChart ChartType="ChartType.StackedBar"
                          InputLabels="@barLabels"
                          Width="100%" Height="600px"
                          ChartSeries="@chartSeries"
                          XAxisLabels="@barLabels"
                          LegendPosition="Position.Bottom"
                          Stacked="true" />


            }
        </div>
    </div>



<style>
    .dashboard-container {
        padding: 20px;
    }

    .dashboard-row {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
    }

    .dashboard-card {
        background-color: #f5f5f5;
        border-radius: 8px;
        padding: 20px;
        flex: 1;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .dashboard-value {
        font-size: 24px;
        font-weight: bold;
        color: #2c3e50;
    }

    .dashboard-section {
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .dashboard-table {
        width: 100%;
        border-collapse: collapse;
    }

        .dashboard-table th, .dashboard-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

    .percentage-tooltip {
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 14px;
        pointer-events: none;
    }

    .percentage-legend {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 15px;
        margin-top: 10px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        font-size: 14px;
    }

    .color-box {
        display: inline-block;
        width: 12px;
        height: 12px;
        margin-right: 5px;
        border-radius: 2px;
    }


    /* Add these new rules here */
    ::deep .mud-chart text {
        font-size: 11px;
    }

    ::deep .mud-chart-xaxis text {
        transform: rotate(-45deg) translate(-10px, 0);
        text-anchor: end;
    }
</style>

@code {
    private int totalExits;
    private int totalEntries;
    private int totalSales;
    private int totalProducts;
    private decimal totalStockValue;
    private List<CategoryWithAverageCost> topCategoriesWithAverageCost = new();
    private List<DashboardService.CategoryStock> categoryStocks = new();
    private bool isLoading = true;

    // Data for pie chart
    private double[] categoryStockData = Array.Empty<double>();
    private string[] categoryLabels = Array.Empty<string>();
    private double[] categoryPercentages = Array.Empty<double>();

    // Tooltip data
    private bool showPercentageTooltip = false;
    private int selectedSegment = 0;
    private double tooltipX = 0;
    private double tooltipY = 0;

    // Chart colors
    private string[] chartColors = new[]
    {
        "#1E88E5", "#43A047", "#FB8C00", "#E53935", "#5E35B1",
        "#546E7A", "#D81B60", "#8E24AA", "#3949AB", "#039BE5"
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardDataAsync();
        await LoadStackedBarDataAsync();
    }

    private async Task LoadDashboardDataAsync()
    {
        try
        {
            isLoading = true;

            // Add new tasks for exits and entries
            var exitsTask = DashboardService.GetTotalStockExitsTodayAsync();
            var entriesTask = DashboardService.GetTotalStockEntriesTodayAsync();

            var salesTask = DashboardService.GetTotalSalesAsync();
            var stockValueTask = DashboardService.GetTotalStockValueAsync();
            var categoriesTask = DashboardService.GetTopCategoriesAsync();
            var stocksByCategoryTask = DashboardService.GetStockByCategoryAsync();

            await Task.WhenAll(salesTask, stockValueTask, categoriesTask, stocksByCategoryTask, exitsTask, entriesTask);

            totalSales = await salesTask;
            totalStockValue = await stockValueTask;
            var categories = await categoriesTask;
            categoryStocks = await stocksByCategoryTask;
            totalExits = await exitsTask;
            totalEntries = await entriesTask;

            // Prepare pie chart data
            PrepareChartData();

            // Load average costs and total quantity for each category
            topCategoriesWithAverageCost.Clear();
            foreach (var category in categories)
            {
                try
                {
                    var averageCost = await DashboardService.GetAverageCostPriceAsync(category.CategoryId);

                    // Get total quantity for this category
                    var totalQuantity = 0;
                    var productsInCategory = categoryStocks
                        .Where(c => c.CategoryId == category.CategoryId)
                        .Select(c => c.TotalStock)
                        .FirstOrDefault();
                    totalQuantity = (int)productsInCategory;

                    topCategoriesWithAverageCost.Add(new CategoryWithAverageCost
                        {
                            CategoryId = category.CategoryId,
                            CategoryName = category.CategoryName,
                            ProductCount = category.ProductCount,
                            TotalQuantity = totalQuantity,
                            AverageCost = averageCost
                        });
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error loading average cost for category {category.CategoryId}: {ex.Message}");
                    topCategoriesWithAverageCost.Add(new CategoryWithAverageCost
                        {
                            CategoryId = category.CategoryId,
                            CategoryName = category.CategoryName,
                            ProductCount = category.ProductCount,
                            TotalQuantity = 0,
                            AverageCost = 0
                        });
                }
            }


            // Calculate total products
            totalProducts = topCategoriesWithAverageCost.Sum(c => c.ProductCount);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void PrepareChartData()
    {
        if (categoryStocks == null || !categoryStocks.Any())
            return;

        var top5Categories = categoryStocks.OrderByDescending(c => c.TotalStock).Take(5).ToList();
        var otherCategoriesStock = categoryStocks.OrderByDescending(c => c.TotalStock).Skip(5).Sum(c => c.TotalStock);

        var dataList = top5Categories.Select(c => (double)c.TotalStock).ToList();
        var labelsList = top5Categories.Select(c => c.CategoryName).ToList();

        if (otherCategoriesStock > 0)
        {
            dataList.Add(otherCategoriesStock);
            labelsList.Add("Other");
        }

        categoryStockData = dataList.ToArray();

        double total = categoryStockData.Sum();
        categoryPercentages = categoryStockData.Select(value => Math.Round((value / total) * 100, 1)).ToArray();

        // This line is the key:
        categoryLabels = labelsList
            .Select((label, i) => $"{label} ({categoryPercentages[i]}%)")
            .ToArray();
    }


    // Event handlers for tooltips
    private void ShowPercentage(int index)
    {
        selectedSegment = index;
        showPercentageTooltip = true;
        tooltipX = 100; // Set appropriate X position
        tooltipY = 100; // Set appropriate Y position
        StateHasChanged();
    }

    private void HidePercentage()
    {
        showPercentageTooltip = false;
        StateHasChanged();
    }

    // Placeholder methods for chart segment customization
    private string GetSegmentPath(int index)
    {
        // This would need actual chart geometry calculation
        // For now, returning empty since MudBlazor handles the actual segments
        return "";
    }

    private string GetSegmentColor(int index)
    {
        return chartColors[index % chartColors.Length];
    }

    private class CategoryWithAverageCost
    {
        public int CategoryId { get; set; }
        public string CategoryName { get; set; } = string.Empty;
        public int ProductCount { get; set; }
        public int TotalQuantity { get; set; }
        public decimal AverageCost { get; set; }
    }
    private double[] stackedBarData = Array.Empty<double>();
    private string[] barLabels = Array.Empty<string>();
    private string[] barCategories = Array.Empty<string>();

    private async Task LoadStackedBarDataAsync()
    {
        try
        {
            var data = await DashboardService.GetDailyMovementsByCategoryAsync();

            // Prepare the last 15 days as DateTime (oldest to newest)
            var dates = Enumerable.Range(0, 15)
                .Select(i => DateTime.Today.AddDays(-14 + i).Date)
                .ToArray();

            barLabels = dates.Select(d => d.ToString("MM/dd")).ToArray();

            // Get all unique categories
            var categories = data.Select(d => d.Category).Distinct().ToArray();

            // Build the chart series: one per category
            chartSeries = new List<ChartSeries>();
            foreach (var category in categories)
            {
                var categoryData = new double[dates.Length];
                for (int i = 0; i < dates.Length; i++)
                {
                    var date = dates[i];
                    // Find the value for this category and date, or 0 if missing
                    var value = data.FirstOrDefault(d => d.Category == category && d.Date.Date == date);
                    categoryData[i] = value != null ? Convert.ToDouble(value.Total) : 0;
                }
                chartSeries.Add(new ChartSeries
                    {
                        Name = category,
                        Data = categoryData
                    });
            }

        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading bar chart data: {ex.Message}");
        }
    }

    private List<ChartSeries> chartSeries = new();

    private List<ChartSeries> GetChartSeries()
    {
        return chartSeries;
    }


    private double[] GetCategoryData(int categoryIndex)
    {
        // Extract data for a specific category across all dates
        int datesCount = barLabels.Length;
        int startIndex = categoryIndex * datesCount;

        return stackedBarData
            .Skip(startIndex)
            .Take(datesCount)
            .ToArray();
    }


}
